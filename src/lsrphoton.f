	SUBROUTINE LSRPHOTON(LSR,LTS,TS,NPH,TXYS,EP,NPH1,IRTN)
C  Generates laser photons. For plotting use.
C  S or T coordinate must be specified.
C      LTS=1:  TS=T,  LTS=2:  TS=S
C  NPH: number of photons to be generated. 
C  NPH1: number of actually generated photons
C  IRTN:0  normal
C       1  not enough number has been generated
C      >=1000   serious
	USE LASRDATA
	IMPLICIT NONE
	INTEGER LSR,NPH,LTS,IRTN
	REAL(8) TS,TXYS(0:3,NPH),EP(0:3,NPH)
	INCLUDE 'include/lasrcm.h'
	INTEGER NPH1,I
	INTEGER NREPEAT
	REAL(8) X1,TXYS1(0:3),EV(3,3),OMG,PD,PD0
	REAL(8) RANDCAIN
	REAL(8) HBARC/1.97327053D-7/

	IF(LSR.LE.0.OR.LSR.GT.NLSR) GOTO 900
	IF(NPH.LE.0) GOTO 910
	IF(LTS.LE.0.OR.LTS.GE.3) GOTO 920

	NPH1=0
	NREPEAT=0
200   NREPEAT=NREPEAT+1
	IF(NREPEAT.GT.1000000) GOTO 930
	DO I=1,2
        X1=RANDCAIN()
	  TXYS1(I)=LSRRNG(1,I,LSR)*(1-X1)+LSRRNG(2,I,LSR)*X1
	ENDDO
	X1=RANDCAIN()
	X1=LSRRNG(1,0,LSR)*(1-X1)+LSRRNG(2,0,LSR)*X1
	IF(LTS.EQ.1) THEN
	  TXYS1(0)=TS
	  TXYS1(3)=TS-X1
	ELSE
	  TXYS1(0)=TS+X1
	  TXYS1(3)=TS
	ENDIF
	CALL LSRCOORD(LSR,TXYS1,1)
	CALL LSRGEO(LSR,TXYS1,PD,PD0,EV,OMG,0)
	X1=RANDCAIN()
	IF(X1.GE.PD0/PLSR(LSR)) GOTO 200
	NPH1=NPH1+1
	TXYS(0:3,NPH1)=TXYS1(0:3)
	EP(0,NPH1)=HBARC*OMG
	EP(1:3,NPH1)=EP(0,NPH1)*EV(1:3,3)
	IF(NPH1.LT.NPH) GOTO 200
	IRTN=0
	RETURN
900   IRTN=1000
	RETURN
910   IRTN=1001
	RETURN
920   IRTN=1002
	RETURN
930   IF(NPH1.EQ.0) THEN
        IRTN=1003
	ELSE
		IRTN=1
	ENDIF
	RETURN
	END

