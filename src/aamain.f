C          PROGRAM CAIN
	USE BEAMCM
	USE BBCOM
	USE LASRDATA
      IMPLICIT NONE
      INTEGER MLINE,MCHAR,MCMD
      PARAMETER (MLINE=3000,MCHAR=256,MCMD=1000)
      INTEGER NCHAR(MLINE),NCHAR2(MLINE),
     %    ICMD(MCMD),CMDLN(2,4,MCMD)
      CHARACTER*(MCHAR) LINE(MLINE)
      INTEGER NLINE,NCMD,IRTN,IC,L,i,j,ISTOP
	INCLUDE 'include/alloccm.h'
      INCLUDE 'include/cmdnam.h'
      INCLUDE 'include/ctrlcm.h'
      INCLUDE 'include/nestcm.h'
C      INCLUDE 'include/beamcm.h'
C      INCLUDE 'include/bbcom.h'
      INCLUDE 'include/lasrcm.h'
C
      ISTOP=0
      CALL CPUTIM('Total',1) 
      CALL INITLZ(IRTN)
      IF(IRTN.NE.0) GOTO 9000
	OSID=0
	MSGDEST=0
      CALL DEFFILES(IRTN)
      IF(IRTN.NE.0) GOTO 9000
	CALL OPENLOGO

      CALL RDALL(LINE,MLINE,NLINE,NCHAR,NCHAR2,
     %   ICMD,MCMD,NCMD,CMDLN,IRTN)
	IF(MSGDEST.GE.2) CALL FILEECHO(1)
      IF(IRTN.NE.0) THEN
        WRITE(MSGFL,170) NLINE,NCMD
 170    FORMAT(' NLINE=',I4,' NCMD=',I4)
        WRITE(MSGFL,180) (L,NCHAR(L),NCHAR2(L),L=1,NLINE)
 180    FORMAT(' LINE#=',I2,'  NCHAR=',I3,' NCHAR2=',I3)
        WRITE(MSGFL,190) (L,CMD(ICMD(L)),((CMDLN(I,J,L),I=1,2),J=1,4),
     %       L=1,NCMD)
 190    FORMAT((' CMD#=',I2,' CMD=',A8,' CMDLN=',4('(',I3,',',I3,') ')))
        GOTO 9000
      ENDIF
C
      NESTLV=0
      NESTRT=0
      INPUSH=0
      IC=0
 200  IC=IC+1
 300  IF(IC.GT.NCMD) GOTO 8000
 	IF(IALLOC.EQ.0.AND.CMD(ICMD(IC)).NE.'HEADER'.AND.
     %  CMD(ICMD(IC)).NE.'SET'.AND.CMD(ICMD(IC)).NE.'ALLOCATE') THEN
	  CALL ALLOCMEM(1,IRTN)
	  IF(IRTN.NE.0) GOTO 9000
	ENDIF
      IF(ECHO.NE.0) THEN
        CALL PRCMD(IC,CMDLN,NCMD,LINE,NCHAR,NCHAR2)
      ENDIF
	IF(MSGDEST.GE.2) CALL FILEECHO(1)
      GOTO (1000,1100,1150,1200,1300,1400,1500,1600,1650,1700,1800,1900,
C           ALLC SET  ARRY FLAG BEAM LASR LQED EXTF CFQED LUM BBFL PPINT 
     %      2000,2100,2200,2300,2400,2500,2600,2700,2800,2900,
C           DRFT LORE PUSH ENDP MAGN BMLN BLOP MTCH TRAN ENDT
     %      3400,3500,3550,3600,3700,3800,3820,3840,3900,4000,4100,4200,
C           CLEA IF   ELIF ELSE ENDI DO   CYCL EXIT ENDD PRNT WRIT PLOT
     %      4300,4400,4500,4600,5000,8000,8000), ICMD(IC)
C           FILE,HEAD,STOR,REST,DBGF,STOP END
C
 1000 CALL RDALLOC(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
	IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1100 CALL RDSET(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1150 CALL RDARRAY(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1200 CALL RDFLAG(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1300 CALL RDBEAM(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1400 CALL RDLASR(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1500 CALL RDLQED(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1600 CALL RDEXTF(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1650 CALL RDCFQD(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200 
 1700 CALL RDLUM(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1800 CALL RDBBFL(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 1900 CALL RDPPI(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 2000 CALL RDDRFT(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 2100 CALL RDLRNZ(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 2200 CALL RDPUSH(IC,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 2300 CALL RDENDP(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.GE.2) GOTO 9000
      IF(IRTN.EQ.1) GOTO 200
      IC=ICNEST(NESTLV)
      GOTO 300
 2400 CALL RDMAGNET(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 2500 CALL RDBEAMLN(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 2600 CALL RDBLOPT(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 2700 CALL RDMATCH(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 2800 CALL RDTRANS(IC,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 2900 CALL RDENDTRANS(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.GE.2) GOTO 9000
      IF(IRTN.EQ.1) GOTO 200
      IC=ICNEST(NESTLV)
      GOTO 300
 3400 CALL RDCLR(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 3500 CALL RDIF(IC,ICMD,NCMD,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 300
 3550 CALL RDELSEIF(IC,ICMD,NCMD,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 300
 3600 CALL RDELSE(IC,ICMD,NCMD,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 300
 3700 CALL RDEDIF(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 3800 CALL RDDO(IC,ICMD,NCMD,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 300
 3820 CALL RDCYCEXT(1,IC,ICMD,NCMD,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 300
 3840 CALL RDCYCEXT(2,IC,ICMD,NCMD,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 300
 3900 CALL RDEDDO(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.GE.2) GOTO 9000
      IF(IRTN.EQ.1) GOTO 200
      IC=ICNEST(NESTLV)
      GOTO 300
 4000 CALL RDWRIT(1,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 4100 CALL RDWRIT(2,CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 4200 CALL RDPLOT(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 4300 CALL RDFILE(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 4400 CALL RDHEAD(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 4500 CALL RDSTOR(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 4600 CALL RDREST(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
      IF(IRTN.NE.0) GOTO 9000
      GOTO 200
 5000 CALL RDDBGFLG(CMDLN(1,1,IC),LINE,NCHAR,IRTN)
	GOTO 200
 8000 GOTO 9999
 9000 WRITE(MSGFL,9010)
 9010 FORMAT(' ***** CAIN Abnormal Termination *****')
      ISTOP=10
C
 9999 CALL CPUTIM('Total',2) 
      CALL CPUTIM('    ',3) 
      IF(ISTOP.NE.0) THEN
        CALL STOPCAIN(10)
      ELSE
        CALL STOPCAIN(0)
      ENDIF
      END
